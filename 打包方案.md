# Vue 组件库打包方案

## 一、方案概述

基于 **Rollup** 构建 Vue 3 组件库的打包方案，支持按组件拆分打包，实现按需引入。

| 项目 | 说明 |
|------|------|
| 打包工具 | Rollup 4.x |
| 入口文件 | `packages/ep/index.ts` |
| 输出格式 | ESM（ES Module） |
| 输出目录 | `dist/` |
| 类型声明 | 使用 `vue-tsc` 生成 `.d.ts` 文件 |

---

## 二、技术选型

### 2.1 核心插件

| 插件 | 版本 | 用途 |
|------|------|------|
| `@vitejs/plugin-vue` | ^5.x | 编译 `.vue` 单文件组件 |
| `rollup-plugin-esbuild` | ^6.x | 编译 TypeScript / ESNext，构建速度快 |
| `@rollup/plugin-node-resolve` | ^15.x | 解析 `node_modules` 中的模块 |
| `@rollup/plugin-commonjs` | ^28.x | 将 CommonJS 模块转换为 ES Module |
| `fast-glob` | ^3.x | 批量获取组件入口文件路径 |
| `vue-tsc` | ^2.x | 生成 Vue 组件的类型声明文件 |

### 2.2 选型理由

**为什么选择 `@vitejs/plugin-vue` 而不是 `rollup-plugin-vue`？**

- `@vitejs/plugin-vue` 是 Vite 官方维护的插件，本质上是一个 Rollup 插件
- 与 Vue 3 生态保持同步更新，兼容性更好
- 社区活跃度高，问题修复及时

**为什么选择 `rollup-plugin-esbuild` 而不是 `@rollup/plugin-typescript`？**

- esbuild 编译速度比 tsc 快 10-100 倍
- 对于类型检查，单独使用 `vue-tsc` 进行，职责分离更清晰

**为什么选择 `vue-tsc` 生成类型声明？**

- `vue-tsc` 是 `tsc` 的 Vue 版本，能正确解析 `.vue` 文件中的类型
- 生成的 `.d.ts` 文件结构与源码一致，适合按需引入场景
- 相比 `rollup-plugin-dts` 或 `@microsoft/api-extractor`，配置更简单

---

## 三、目录结构设计

### 3.1 源码结构

```
packages/
├── components/                 # 组件包
│   ├── button/
│   │   ├── index.ts           # 组件导出入口
│   │   ├── src/
│   │   │   └── button.vue     # 组件实现
│   │   └── style/
│   │       └── index.ts       # 样式入口
│   ├── input/
│   │   ├── index.ts
│   │   ├── src/
│   │   │   └── input.vue
│   │   └── style/
│   │       └── index.ts
│   └── index.ts               # 全量导出
├── ep/
│   └── index.ts               # 组件库总入口
├── hooks/                      # 公共 Hooks
├── utils/                      # 工具函数
└── theme-chalk/               # 样式主题
```

### 3.2 构建脚本结构

```
build/
├── package.json
├── paths.ts                   # 路径常量定义
├── plugins.ts                 # Rollup 插件配置
├── build-modules.ts           # 按模块打包逻辑
└── index.ts                   # 打包入口脚本
```

### 3.3 输出结构

```
dist/
├── es/                        # ESM 格式输出
│   ├── components/
│   │   ├── button/
│   │   │   ├── index.mjs
│   │   │   └── src/
│   │   │       └── button.mjs
│   │   ├── input/
│   │   │   ├── index.mjs
│   │   │   └── src/
│   │   │       └── input.mjs
│   │   └── index.mjs
│   ├── hooks/
│   │   └── index.mjs
│   ├── utils/
│   │   └── index.mjs
│   └── index.mjs              # 全量入口
└── types/                     # 类型声明文件
    ├── components/
    │   ├── button/
    │   │   ├── index.d.ts
    │   │   └── src/
    │   │       └── button.d.ts
    │   └── ...
    └── index.d.ts
```

---

## 四、依赖清单

需要安装到 `devDependencies` 的依赖：

```bash
pnpm add -D @vitejs/plugin-vue rollup-plugin-esbuild @rollup/plugin-node-resolve @rollup/plugin-commonjs fast-glob vue-tsc -w
```

完整依赖列表：

```json
{
  "devDependencies": {
    "@rollup/plugin-commonjs": "^28.0.0",
    "@rollup/plugin-node-resolve": "^15.3.0",
    "@vitejs/plugin-vue": "^5.2.0",
    "fast-glob": "^3.3.0",
    "rollup": "^4.9.0",
    "rollup-plugin-esbuild": "^6.1.0",
    "typescript": "^5.9.0",
    "vue": "^3.4.0",
    "vue-tsc": "^2.2.0"
  }
}
```

---

## 五、打包流程

```
┌─────────────────────────────────────────────────────────────┐
│                        打包流程                              │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 清理 dist 目录                                          │
│         ↓                                                   │
│  2. 使用 fast-glob 收集所有组件入口文件                       │
│         ↓                                                   │
│  3. Rollup 打包                                             │
│     ├── @vitejs/plugin-vue 处理 .vue 文件                   │
│     ├── rollup-plugin-esbuild 编译 TypeScript               │
│     ├── @rollup/plugin-node-resolve 解析模块                │
│     └── @rollup/plugin-commonjs 处理 CJS                    │
│         ↓                                                   │
│  4. 输出 ESM 格式到 dist/es/                                 │
│         ↓                                                   │
│  5. vue-tsc 生成类型声明到 dist/types/                       │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、使用方式（打包完成后）

### 6.1 全量引入

```typescript
import EP from '@ep/components'
import '@ep/theme-chalk/index.css'

app.use(EP)
```

### 6.2 按需引入

```typescript
import { Button, Input } from '@ep/components'
import '@ep/theme-chalk/button.css'
import '@ep/theme-chalk/input.css'

app.use(Button)
app.use(Input)
```

---

## 七、后续扩展

| 扩展项 | 说明 |
|--------|------|
| UMD 格式 | 支持 CDN 引入，通过 `<script>` 标签直接使用 |
| CSS 打包 | 使用 `gulp` 或 `postcss` 处理 SCSS/Less |
| 自动导入插件 | 配合 `unplugin-vue-components` 实现自动按需引入 |

